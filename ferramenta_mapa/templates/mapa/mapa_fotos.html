{% extends 'base.html' %}

{% block title %}Mapa de Fotos - Resolve Eng{% endblock %}

{% block content %}
<!-- Importando Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    #map {
        height: 75vh; /* Altura do mapa */
        width: 100%;
        border-radius: 12px;
        z-index: 1;
    }
    .thumb-popup {
        width: 200px;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 0;
        overflow: hidden;
    }
    .leaflet-popup-content {
        margin: 15px;
        text-align: center;
    }
    .sidebar-control {
        max-height: 75vh;
        overflow-y: auto;
    }
</style>

<div id="app-mapa" class="container-fluid p-0">
    <div class="row g-3">
        
        <!-- Painel de Controle (Esquerda) -->
        <div class="col-lg-3">
            <div class="card shadow-sm sidebar-control h-100">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-geo-alt"></i> GeoFotos</h5>
                    <small class="text-muted">Processamento local</small>
                </div>
                <div class="card-body">
                    
                    <div class="alert alert-info small border-0 bg-info bg-opacity-10">
                        <i class="bi bi-shield-lock"></i> As fotos são processadas no seu navegador. Nenhuma imagem é enviada ao servidor.
                    </div>

                    <div class="d-grid gap-2 mb-3">
                        <!-- Botão para Arquivos Soltos -->
                        <label class="btn btn-primary">
                            <i class="bi bi-images"></i> Selecionar Fotos
                            <input type="file" hidden multiple accept="image/jpeg, image/jpg, image/png" @change="processarArquivos">
                        </label>

                        <!-- Botão para Pasta Inteira (WebKit) -->
                        <label class="btn btn-outline-secondary" title="Funciona em Chrome/Edge">
                            <i class="bi bi-folder"></i> Selecionar Pasta
                            <input type="file" hidden webkitdirectory directory multiple @change="processarArquivos">
                        </label>
                    </div>

                    <!-- Status do Processamento -->
                    <div v-if="processando" class="text-center my-3">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                        <span class="ms-2 small">Lendo GPS... ([[ fotosProcessadas ]]/[[ totalFotos ]])</span>
                    </div>

                    <!-- Lista de Fotos Encontradas -->
                    <div v-if="marcadores.length > 0">
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="fw-bold text-uppercase text-muted">Fotos no Mapa</small>
                            <span class="badge bg-secondary rounded-pill">[[ marcadores.length ]]</span>
                        </div>
                        
                        <div class="list-group list-group-flush small">
                            <button v-for="(foto, index) in marcadores" :key="index" 
                                    @click="focarNoMapa(foto)"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-2">
                                <span class="text-truncate" style="max-width: 150px;">[[ foto.nome ]]</span>
                                <i class="bi bi-crosshair text-primary"></i>
                            </button>
                        </div>
                        
                        <button @click="limparMapa" class="btn btn-outline-danger btn-sm w-100 mt-3">
                            <i class="bi bi-trash"></i> Limpar Tudo
                        </button>
                    </div>

                    <div v-else-if="!processando" class="text-center text-muted mt-5">
                        <i class="bi bi-map fs-1 opacity-25"></i>
                        <p class="small mt-2">Nenhuma foto com coordenadas GPS carregada.</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- Mapa (Direita) -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Vue.js -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Exifr (Extração de Metadados Rápida) -->
<script src="https://unpkg.com/exifr/dist/full.esm.mjs"></script>

<script type="module">
    // Importação via módulo para o exifr funcionar corretamente no navegador moderno
    import exifr from 'https://unpkg.com/exifr/dist/full.esm.mjs';

    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                map: null,
                marcadores: [], // Armazena dados das fotos: {lat, lng, nome, url, data}
                markersLayer: null, // Camada do Leaflet para os pinos
                processando: false,
                totalFotos: 0,
                fotosProcessadas: 0
            }
        },
        mounted() {
            this.initMap();
        },
        methods: {
            initMap() {
                // Configuração Inicial do Mapa (Nova Petrópolis como centro padrão)
                this.map = L.map('map').setView([-29.3747, -51.1136], 13);

                // Camada 1: Mapa de Ruas (OpenStreetMap)
                const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                });

                // Camada 2: Satélite (Esri World Imagery) - Ótimo para Engenharia
                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri'
                });

                // Adiciona Satélite como padrão
                satellite.addTo(this.map);

                // Controle de Camadas
                const baseMaps = {
                    "Satélite": satellite,
                    "Ruas": streets
                };
                L.control.layers(baseMaps).addTo(this.map);

                // Grupo de Marcadores
                this.markersLayer = L.layerGroup().addTo(this.map);
            },

            async processarArquivos(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                this.processando = true;
                this.totalFotos = files.length;
                this.fotosProcessadas = 0;

                for (const file of files) {
                    try {
                        // 1. Extrair GPS e Data usando exifr (super rápido)
                        const dados = await exifr.parse(file, { gps: true, tiff: true });

                        if (dados && dados.latitude && dados.longitude) {
                            
                            // 2. Criar URL temporária para exibir a imagem (blob)
                            const imageUrl = URL.createObjectURL(file);
                            
                            // 3. Formatar Data
                            let dataFormatada = "Data desc.";
                            if (dados.DateTimeOriginal) {
                                dataFormatada = new Date(dados.DateTimeOriginal).toLocaleString('pt-BR');
                            }

                            const fotoObj = {
                                nome: file.name,
                                lat: dados.latitude,
                                lng: dados.longitude,
                                url: imageUrl,
                                data: dataFormatada,
                                markerRef: null // Guardar referência do pino do Leaflet
                            };

                            this.adicionarAoMapa(fotoObj);
                            this.marcadores.push(fotoObj);
                        }
                    } catch (error) {
                        console.warn(`Erro ao ler ${file.name}:`, error);
                    } finally {
                        this.fotosProcessadas++;
                    }
                }

                // Ajustar zoom para mostrar todos os pontos
                if (this.marcadores.length > 0) {
                    const grupo = L.featureGroup(this.marcadores.map(m => m.markerRef));
                    this.map.fitBounds(grupo.getBounds().pad(0.2));
                }

                this.processando = false;
                // Limpar o input para permitir selecionar os mesmos arquivos se quiser
                event.target.value = ''; 
            },

            adicionarAoMapa(foto) {
                // Criar ícone personalizado ou usar padrão
                const marker = L.marker([foto.lat, foto.lng]).addTo(this.markersLayer);
                
                // Conteúdo do Popup (HTML)
                const popupContent = `
                    <div class="text-center">
                        <img src="${foto.url}" class="thumb-popup" alt="Foto">
                        <div class="fw-bold small">${foto.nome}</div>
                        <div class="text-muted small"><i class="bi bi-calendar"></i> ${foto.data}</div>
                        <a href="${foto.url}" target="_blank" class="btn btn-sm btn-primary mt-2 w-100">
                            <i class="bi bi-arrows-fullscreen"></i> Ampliar
                        </a>
                    </div>
                `;

                marker.bindPopup(popupContent);
                foto.markerRef = marker; // Salva referência para clicar na lista lateral e abrir
            },

            focarNoMapa(foto) {
                this.map.flyTo([foto.lat, foto.lng], 18);
                foto.markerRef.openPopup();
            },

            limparMapa() {
                this.markersLayer.clearLayers();
                // Revogar URLs para liberar memória
                this.marcadores.forEach(m => URL.revokeObjectURL(m.url));
                this.marcadores = [];
            }
        }
    }).mount('#app-mapa');
</script>
{% endblock %}
