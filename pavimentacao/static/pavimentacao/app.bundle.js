// Pavimentação.br bundle (no ES modules)
(function(){
  const store = new (class Store {
    constructor(){ this.state = { project:{ name:'Projeto Exemplo Rodovia BR-101', date:new Date().toISOString().split('T')[0], engineer:'' }, traffic:{ Vm:2500, P:10, growthRate:3, growthType:'geometric', FV:2.5, calculatedN:0 }, soil:{ subgradeCBR:4, expansion:1.5, waterTable:2.0, classification:'A-7-6' }, structure:{ surface:{ materialId:'cbuq', thickness:5.0 }, base:{ materialId:'brita', thickness:15.0, cbr:80 }, subbase:{ materialId:'solo_melhorado', thickness:15.0, cbr:20 }, reinforcement:{ materialId:null, thickness:0, cbr:10 }, results:{ hTotal:0, isValid:false, messages:[] } }, drainage:{ area:1000, c:0.95, rainfall_i:150, permeability_k:15, trenchWidth:1.0, porosity:0.35 } }; this.listeners=[]; }
    getState(){ return this.state; }
    updateNested(path, value){ const keys = path.split('.'); let cur=this.state; for(let i=0;i<keys.length-1;i++){ cur=cur[keys[i]]; } cur[keys[keys.length-1]]=value; this.listeners.forEach(l=>l(this.state)); }
  })();

  const MATERIALS = [
    { id: 'cbuq', name: 'Concreto Betuminoso (CBUQ)', k: 2.0, minCBR: 80, type: 'surface' },
    { id: 'pmq', name: 'Pré-misturado a Quente', k: 1.7, minCBR: 80, type: 'surface' },
    { id: 'pmf', name: 'Pré-misturado a Frio', k: 1.4, minCBR: 60, type: 'surface' },
    { id: 'ts', name: 'Tratamento Superficial', k: 1.2, minCBR: 60, type: 'surface' },
    { id: 'brita', name: 'Brita Graduada', k: 1.0, minCBR: 80, type: 'granular' },
    { id: 'solo_brita', name: 'Solo-Brita', k: 1.0, minCBR: 60, type: 'granular' },
    { id: 'solo_cimento_high', name: 'Solo-Cimento (Rc > 45kg/cm²)', k: 1.7, minCBR: 100, type: 'stabilized' },
    { id: 'solo_cimento_med', name: 'Solo-Cimento (28 < Rc < 45)', k: 1.4, minCBR: 100, type: 'stabilized' },
    { id: 'solo_cimento_low', name: 'Solo-Cimento (21 < Rc < 28)', k: 1.2, minCBR: 100, type: 'stabilized' },
    { id: 'solo_melhorado', name: 'Solo Melhorado', k: 1.0, minCBR: 20, type: 'granular' },
    { id: 'solo_local', name: 'Solo Local (Subleito)', k: 1.0, minCBR: 2, type: 'soil' }
  ];
  const MIN_THICKNESS_SURFACE = [
    { maxN: 1.0e6, val: 0 }, { maxN: 5.0e6, val: 5.0 }, { maxN: 1.0e7, val: 7.5 }, { maxN: 5.0e7, val: 10.0 }, { maxN: Infinity, val: 12.5 }
  ];
  const formatScientific = (num)=>{ if(num===0) return '0'; const e=Math.floor(Math.log10(num)); const m=num/Math.pow(10,e); return `${m.toFixed(2)} x 10^${e}`; };
  const calculateN = (Vm,P,rate,type,FV)=>{ const r=rate/100; let Vt=0; if(type==='arithmetic'){ Vt=365*P*Vm*(1+(r*(P-1)/2)); } else { Vt = r===0 ? 365*Vm*P : 365*Vm*((Math.pow(1+r,P)-1)/r); } return Vt*FV; };
  const calculateTotalThickness = (N,CBR)=>{ if(CBR<=0) return 0; return 77.67*Math.pow(N,0.0482)*Math.pow(CBR,-0.598); };

  function renderTraffic(container){ const s=store.getState().traffic; const N=calculateN(s.Vm,s.P,s.growthRate,s.growthType,s.FV); if(N!==s.calculatedN) store.updateNested('traffic.calculatedN',N); container.innerHTML=`<div class="animate-fade-in max-w-4xl mx-auto"><h2 class="text-2xl font-bold text-slate-800 mb-6">Parâmetros de Tráfego</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card p-6"><h3 class="text-lg font-semibold text-dnit-800 mb-4 flex items-center gap-2"><i data-lucide="car" class="w-5 h-5"></i> Dados de Entrada</h3><div class="space-y-4"><div><label class="label-text">Volume Médio Diário ($V_m$)</label><input type="number" id="input-vm" value="${s.Vm}" class="input-field" min="0"><p class="text-xs text-slate-400 mt-1">Veículos/dia</p></div><div class="grid grid-cols-2 gap-4"><div><label class="label-text">Período de Projeto ($P$)</label><div class="relative"><input type="number" id="input-p" value="${s.P}" class="input-field pr-8" min="1" max="50"><span class="absolute right-3 top-2.5 text-xs text-slate-400">anos</span></div></div><div><label class="label-text">Taxa de Crescimento ($t$)</label><div class="relative"><input type="number" id="input-rate" value="${s.growthRate}" class="input-field pr-8" step="0.1"><span class="absolute right-3 top-2.5 text-xs text-slate-400">% a.a.</span></div></div></div><div><label class="label-text">Tipo de Crescimento</label><select id="input-growth-type" class="input-field"><option value="geometric" ${s.growthType==='geometric'?'selected':''}>Geométrico</option><option value="arithmetic" ${s.growthType==='arithmetic'?'selected':''}>Aritmético</option></select></div><div><label class="label-text">Fator de Veículo ($FV$)</label><input type="number" id="input-fv" value="${s.FV}" class="input-field" step="0.1"></div></div></div><div class="flex flex-col gap-6"><div class="card p-6 bg-gradient-to-br from-slate-800 to-slate-900 text-white border-none"><h3 class="text-sm font-medium text-slate-300 uppercase tracking-wider mb-2">Número N (Operações)</h3><div class="text-4xl font-bold mb-1" id="display-n">${formatScientific(N)}</div><p class="text-sm text-slate-400">Repetições do eixo padrão de 8,2t</p><div class="mt-6 pt-6 border-t border-slate-700/50 grid grid-cols-2 gap-4"><div><span class="block text-xs text-slate-400">Volume Total ($V_t$)</span><span class="text-lg font-semibold" id="display-vt">${formatScientific(N/s.FV)}</span></div><div><span class="block text-xs text-slate-400">Classe de Tráfego</span><span class="text-lg font-semibold" id="display-class">${N<1e6?'Leve':N<1e7?'Médio':N<5e7?'Pesado':'Muito Pesado'}</span></div></div></div><div class="card p-6 flex-1"><canvas id="trafficChart"></canvas></div></div></div></div>`; if(window.lucide) lucide.createIcons(); ['input-vm','input-p','input-rate','input-fv'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input',updateTraffic); }); const gt=document.getElementById('input-growth-type'); if(gt) gt.addEventListener('change',updateTraffic); renderTrafficChart(s.Vm,s.P,s.growthRate,s.growthType); }
  function renderTrafficChart(vm,p,rate,type){ const ctx=document.getElementById('trafficChart'); if(!ctx || !window.Chart) return; const labels=Array.from({length:p+1},(_,i)=>`Ano ${i}`); const data=labels.map((_,i)=>{ const r=rate/100; return type==='arithmetic'? vm*(1+r*i): vm*Math.pow(1+r,i); }); new Chart(ctx.getContext('2d'),{ type:'line', data:{ labels, datasets:[{ label:'Volume Diário ($V_m$)', data, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.1)', fill:true, tension:0.4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, title:{ display:true, text:'Evolução do Tráfego' } }, scales:{ y:{ beginAtZero:true } } } }); }
  function updateTraffic(){ const vm=Number(document.getElementById('input-vm').value); const p=Number(document.getElementById('input-p').value); const rate=Number(document.getElementById('input-rate').value); const fv=Number(document.getElementById('input-fv').value); const type=document.getElementById('input-growth-type').value; const N=calculateN(vm,p,rate,type,fv); store.updateNested('traffic',{ Vm:vm,P:p,growthRate:rate,growthType:type,FV:fv,calculatedN:N }); document.getElementById('display-n').innerText=formatScientific(N); document.getElementById('display-vt').innerText=formatScientific(N/fv); document.getElementById('display-class').innerText= N<1e6?'Leve':N<1e7?'Médio':N<5e7?'Pesado':'Muito Pesado'; renderTrafficChart(vm,p,rate,type); }

  function renderSoil(container){ const s=store.getState().soil; container.innerHTML=`<div class="animate-fade-in max-w-3xl mx-auto"><h2 class="text-2xl font-bold text-slate-800 mb-6">Caracterização do Subleito</h2><div class="card p-8"><div class="grid grid-cols-1 gap-8"><div><label class="label-text text-lg mb-2">Índice de Suporte Califórnia (CBR/ISC)</label><div class="flex items-center gap-4"><div class="relative flex-1"><input type="number" id="input-cbr" value="${s.subgradeCBR}" class="input-field text-lg py-3" min="1" max="100"><span class="absolute right-4 top-3.5 text-slate-400 font-medium">%</span></div><div class="w-1/2 h-12 bg-slate-100 rounded-lg relative overflow-hidden border border-slate-200"><div id="cbr-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-500" style="width:${Math.min(s.subgradeCBR,20)*5}%"></div><div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-slate-600"><span id="cbr-label">Fraco</span></div></div></div><p class="text-sm text-slate-500 mt-2"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i> O DNIT recomenda substituição para CBR < 2%.</p></div><div class="h-px bg-slate-100"></div><div class="grid grid-cols-2 gap-6"><div><label class="label-text">Expansão</label><div class="relative"><input type="number" id="input-exp" value="${s.expansion}" class="input-field" step="0.1"><span class="absolute right-3 top-2.5 text-slate-400">%</span></div><p id="exp-warning" class="text-xs text-red-500 mt-1 hidden">Atenção: Expansão > 2% exige tratamento.</p></div><div><label class="label-text">Nível do Lençol Freático</label><div class="relative"><input type="number" id="input-wt" value="${s.waterTable}" class="input-field" step="0.1"><span class="absolute right-3 top-2.5 text-slate-400">m</span></div><p class="text-xs text-slate-400 mt-1">Profundidade em relação ao greide</p></div></div><div><label class="label-text">Classificação TRB/AASHTO (Estimada)</label><select id="input-class" class="input-field"><option value="A-1-a">A-1-a</option><option value="A-2-4">A-2-4</option><option value="A-4">A-4</option><option value="A-6">A-6</option><option value="A-7-5">A-7-5</option><option value="A-7-6" selected>A-7-6</option></select></div></div></div></div>`; if(window.lucide) lucide.createIcons(); document.getElementById('input-cbr').addEventListener('input', e=>{ const v=Number(e.target.value); store.updateNested('soil.subgradeCBR',v); updateSoil(v,store.getState().soil.expansion); }); document.getElementById('input-exp').addEventListener('input', e=>{ const v=Number(e.target.value); store.updateNested('soil.expansion',v); updateSoil(store.getState().soil.subgradeCBR,v); }); document.getElementById('input-wt').addEventListener('input', e=>{ store.updateNested('soil.waterTable', Number(e.target.value)); }); document.getElementById('input-class').addEventListener('change', e=>{ store.updateNested('soil.classification', e.target.value); }); updateSoil(s.subgradeCBR,s.expansion); }
  function updateSoil(cbr,exp){ const bar=document.getElementById('cbr-bar'); const label=document.getElementById('cbr-label'); if(!bar||!label) return; bar.style.width=`${Math.min(cbr,20)*5}%`; const text = cbr>=20?'Excelente': cbr>=10?'Bom': cbr>=5?'Regular':'Fraco'; label.innerText=text; const warn=document.getElementById('exp-warning'); if(warn){ if(exp>2.0) warn.classList.remove('hidden'); else warn.classList.add('hidden'); } }

  function renderStructure(container){ const state=store.getState(); const s=state.structure; const N=state.traffic.calculatedN; const subCBR=state.soil.subgradeCBR; const H_needed=calculateTotalThickness(N,subCBR); let minSurf = MIN_THICKNESS_SURFACE.find(rule => N <= rule.maxN) || MIN_THICKNESS_SURFACE[MIN_THICKNESS_SURFACE.length - 1]; const getOptions=(sel,typ)=> MATERIALS.filter(m=>!typ||m.type===typ||m.type==='stabilized').map(m=>`<option value="${m.id}" ${m.id===sel?'selected':''} data-k="${m.k}">${m.name} (K=${m.k})</option>`).join(''); container.innerHTML=`<div class="animate-fade-in flex flex-col lg:flex-row gap-6 h-full"><div class="w-full lg:w-1/2 flex flex-col gap-4 overflow-y-auto pb-8"><h2 class="text-2xl font-bold text-slate-800">Estrutura do Pavimento</h2><div class="grid grid-cols-2 gap-4"><div class="card p-4 border-l-4 border-dnit-500"><span class="text-xs text-slate-500 uppercase">Espessura Total Necessária ($H_m$)</span><div class="text-2xl font-bold text-dnit-800">${H_needed.toFixed(1)} cm</div></div><div class="card p-4 border-l-4 border-emerald-500"><span class="text-xs text-slate-500 uppercase">Espessura Equivalente Atual</span><div class="text-2xl font-bold text-emerald-800" id="current-eq-thickness">0.0 cm</div></div></div><div class="space-y-4">${renderLayerInput('Revestimento','surface',s.surface,getOptions(s.surface.materialId,'surface'),minSurf.val,true)}${renderLayerInput('Base','base',s.base,getOptions(s.base.materialId,'granular'),15.0)}${renderLayerInput('Sub-base','subbase',s.subbase,getOptions(s.subbase.materialId,'granular'),15.0)}${renderLayerInput('Reforço do Subleito','reinforcement',s.reinforcement,getOptions(s.reinforcement.materialId,'granular'),0)}</div><div id="validation-box" class="card p-4 bg-slate-50 border-slate-200 text-sm space-y-2 hidden"></div></div><div class="w-full lg:w-1/2 card p-6 flex flex-col sticky top-0"><h3 class="text-sm font-semibold text-slate-500 uppercase mb-4">Perfil Esquemático</h3><div class="flex-1 bg-sky-50 rounded-lg border border-sky-100 relative overflow-hidden flex items-end justify-center p-8" id="canvas-container"><canvas id="pavementCanvas" class="w-full h-full"></canvas></div><div class="mt-4 flex justify-between text-xs text-slate-400"><span>Subleito CBR ${subCBR}%</span><span>N = ${N.toExponential(2)}</span></div></div></div>`; if(window.lucide) lucide.createIcons(); ['surface','base','subbase','reinforcement'].forEach(layer=>{ const m=document.getElementById(`mat-${layer}`); const t=document.getElementById(`thick-${layer}`); const cbr=document.getElementById(`cbr-${layer}`); if(m) m.addEventListener('change',e=>{ store.updateNested(`structure.${layer}.materialId`, e.target.value); recalc(); }); if(t) t.addEventListener('input',e=>{ store.updateNested(`structure.${layer}.thickness`, Number(e.target.value)); recalc(); }); if(cbr) cbr.addEventListener('input',e=>{ store.updateNested(`structure.${layer}.cbr`, Number(e.target.value)); recalc(); }); }); recalc(); function recalc(){ const st=store.getState(); const s=st.structure; const getK=(id)=> MATERIALS.find(m=>m.id===id)?.k || 1.0; const kR=getK(s.surface.materialId), kB=getK(s.base.materialId), kS=getK(s.subbase.materialId), kRef=getK(s.reinforcement.materialId); const el=(id,v)=>{ const e=document.getElementById(id); if(e) e.innerText=v; }; el('k-surface',kR); el('k-base',kB); el('k-subbase',kS); el('k-reinforcement',kRef); const N=st.traffic.calculatedN; const H20=calculateTotalThickness(N,20); const Hm=calculateTotalThickness(N, st.soil.subgradeCBR); const Eq_Surface_Base=(s.surface.thickness*kR)+(s.base.thickness*kB); const Eq_Total_Subbase=Eq_Surface_Base+(s.subbase.thickness*kS); const Eq_Total=Eq_Total_Subbase+(s.reinforcement.thickness*kRef); el('current-eq-thickness', `${Eq_Total.toFixed(1)} cm`); const msgs=[]; if(Eq_Surface_Base < H20) msgs.push(`⚠️ Estrutura (Rev + Base) insuficiente (Req: ${H20.toFixed(1)} cm eq).`); if(Eq_Total < Hm) msgs.push(`⛔ Total insuficiente (Req: ${Hm.toFixed(1)} cm eq). Faltam ${(Hm-Eq_Total).toFixed(1)} cm.`); const vb=document.getElementById('validation-box'); if(vb){ vb.innerHTML = msgs.length? msgs.map(m=>`<p>${m}</p>`).join('') : `<p class="text-emerald-600 font-semibold"><i data-lucide="check-circle" class="w-4 h-4"></i> Atende aos critérios.</p>`; vb.classList.remove('hidden'); if(window.lucide) lucide.createIcons(); } drawPavement(s); }
  }
  function renderLayerInput(label,key,data,options,minVal,isSurface){ return `<div class="card p-4 layer-card" data-layer="${key}"><div class="flex justify-between items-center mb-3"><h4 class="font-semibold text-slate-700 flex items-center gap-2"><i data-lucide="${isSurface?'layers':'box'}" class="w-4 h-4 text-dnit-500"></i> ${label}</h4><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">K = <span id="k-${key}">-</span></span></div><div class="grid grid-cols-3 gap-3"><div class="col-span-2"><label class="label-text">Material</label><select id="mat-${key}" class="input-field text-sm py-1">${options}</select></div><div><label class="label-text">Espessura (cm)</label><input type="number" id="thick-${key}" value="${data.thickness}" class="input-field text-sm py-1" min="0" step="1"></div></div>${!isSurface? `<div class="mt-2"><label class="label-text">CBR do Material (%)</label><input type="number" id="cbr-${key}" value="${data.cbr||0}" class="input-field text-sm py-1 w-1/3"></div>`:''}${minVal>0? `<p class="text-[10px] text-slate-400 mt-2">Mínimo recomendado: ${minVal} cm</p>`:''}</div>`; }
  function drawPavement(layers){ const canvas=document.getElementById('pavementCanvas'); if(!canvas) return; const ctx=canvas.getContext('2d'); canvas.width=canvas.parentElement.offsetWidth; canvas.height=canvas.parentElement.offsetHeight; const w=canvas.width, h=canvas.height; ctx.clearRect(0,0,w,h); const total=layers.surface.thickness+layers.base.thickness+layers.subbase.thickness+layers.reinforcement.thickness+20; const scale=(h-40)/total; let y=20; const draw=(th,color,label)=>{ if(th<=0) return; const hp=th*scale; ctx.fillStyle=color; ctx.fillRect(50,y,w-100,hp); ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.strokeRect(50,y,w-100,hp); ctx.fillStyle='#334155'; ctx.font='12px Inter'; ctx.fillText(label,w-45,y+hp/2+4); ctx.fillText(`${th} cm`,10,y+hp/2+4); y+=hp; }; draw(layers.surface.thickness,'#334155','Revestimento'); draw(layers.base.thickness,'#94a3b8','Base'); draw(layers.subbase.thickness,'#cbd5e1','Sub-base'); draw(layers.reinforcement.thickness,'#e2e8f0','Reforço'); ctx.fillStyle='#885533'; ctx.fillRect(50,y,w-100,h-y); ctx.fillStyle='white'; ctx.fillText('Subleito', w/2-20, y+20); }

  function renderDrainage(container){ const s=store.getState().drainage; const opts=[{ id:'roof', name:'Telhados / Impermeável', c:0.95 },{ id:'asphalt', name:'Asfalto / Concreto', c:0.90 },{ id:'paver', name:'Blocos / Pav. Permeável', c:0.50 },{ id:'soil', name:'Solo Exposto', c:0.40 },{ id:'green', name:'Área Verde', c:0.15 }]; const surfaceOptions=opts.map(o=>`<option value="${o.c}" ${o.c===s.c?'selected':''}>${o.name} (C=${o.c})</option>`).join(''); container.innerHTML=`<div class="animate-fade-in max-w-4xl mx-auto"><h2 class="text-2xl font-bold text-slate-800 mb-6">Drenagem e Pavimento Permeável</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card p-6"><h3 class="font-semibold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="cloud-rain" class="w-5 h-5 text-blue-500"></i> Hidrologia</h3><div class="space-y-4"><div><label class="label-text">Área de Contribuição ($A$)</label><div class="relative"><input type="number" id="drain-area" value="${s.area}" class="input-field" min="0"><span class="absolute right-3 top-2.5 text-slate-400 text-xs">m²</span></div></div><div><label class="label-text">Tipo de Superfície (Run-off $C$)</label><select id="drain-c" class="input-field">${surfaceOptions}</select></div><div><label class="label-text">Intensidade de Chuva ($I$)</label><div class="relative"><input type="number" id="drain-i" value="${s.rainfall_i}" class="input-field" min="0"><span class="absolute right-3 top-2.5 text-slate-400 text-xs">mm/h</span></div><p class="text-xs text-slate-400 mt-1">Para TR projetado</p></div></div></div><div class="card p-6"><h3 class="font-semibold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="layers" class="w-5 h-5 text-emerald-500"></i> Parâmetros do Solo/Base</h3><div class="space-y-4"><div><label class="label-text">Permeabilidade do Solo ($K_{sat}$)</label><div class="relative"><input type="number" id="drain-k" value="${s.permeability_k}" class="input-field" min="0"><span class="absolute right-3 top-2.5 text-slate-400 text-xs">mm/h</span></div></div><div><label class="label-text">Porosidade da Base ($η$)</label><div class="relative"><input type="number" id="drain-p" value="${s.porosity}" class="input-field" min="0" max="1" step="0.01"><span class="absolute right-3 top-2.5 text-slate-400 text-xs">dec</span></div><p class="text-xs text-slate-400 mt-1">Brita comum ≈ 0.35 - 0.40</p></div></div></div></div><div class="mt-6 card p-6 bg-white border-l-4 border-blue-500"><h3 class="text-lg font-bold text-slate-800 mb-4">Resultados de Dimensionamento</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><span class="text-xs text-slate-500 uppercase">Vazão de Pico ($Q$)</span><div class="text-3xl font-bold text-blue-600" id="res-q">-</div><span class="text-xs text-slate-400">Litros/segundo</span></div><div><span class="text-xs text-slate-500 uppercase">Volume Armazenamento</span><div class="text-3xl font-bold text-slate-700" id="res-vol">-</div><span class="text-xs text-slate-400">m³ necessários</span></div><div><span class="text-xs text-slate-500 uppercase">Espessura Camada Porosa</span><div class="text-3xl font-bold text-emerald-600" id="res-h">-</div><span class="text-xs text-slate-400">cm</span></div></div><div id="drain-alert" class="mt-4 text-sm p-3 bg-yellow-50 text-yellow-700 rounded hidden"></div></div></div>`; if(window.lucide) lucide.createIcons(); ['drain-area','drain-c','drain-i','drain-k','drain-p'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', e=>{ const map={ 'drain-area':'area','drain-c':'c','drain-i':'rainfall_i','drain-k':'permeability_k','drain-p':'porosity' }; store.updateNested(`drainage.${map[id]}`, Number(e.target.value)); calcDrainage(); }); }); calcDrainage(); }
  function calcDrainage(){ const s=store.getState().drainage; const Q=(s.c*s.rainfall_i*s.area)/3.6; const RainVol=(s.rainfall_i/1000)*s.area; const InfilVol=(s.permeability_k/1000)*s.area; const NetVol=Math.max(0,RainVol-InfilVol); const H_cm = (NetVol/(s.area*s.porosity))*100; const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.innerText=v; }; set('res-q', Q.toFixed(1)); set('res-vol', NetVol.toFixed(1)); set('res-h', H_cm.toFixed(1)); const alert=document.getElementById('drain-alert'); if(alert){ if(s.permeability_k<5){ alert.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i> Permeabilidade muito baixa (${s.permeability_k} mm/h).`; alert.classList.remove('hidden'); if(window.lucide) lucide.createIcons(); } else { alert.classList.add('hidden'); } } }

  function renderReport(container){ const st=store.getState(); container.innerHTML=`<div class="animate-fade-in max-w-4xl mx-auto bg-white p-8 shadow-lg rounded-lg" id="print-area"><div class="flex justify-between items-start border-b border-slate-200 pb-6 mb-6"><div><h1 class="text-3xl font-bold text-slate-900">Relatório de Dimensionamento</h1><p class="text-slate-500 mt-1">Método DNIT (IPR-719)</p></div><div class="text-right"><div class="text-sm text-slate-400">Data</div><div class="font-medium">${st.project.date}</div></div></div><div class="space-y-8"><section><h3 class="text-lg font-bold text-dnit-800 border-b border-dnit-100 pb-2 mb-4">1. Parâmetros de Tráfego</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"><div><span class="block text-slate-500">Volume Médio ($V_m$)</span><span class="font-semibold">${st.traffic.Vm} vpd</span></div><div><span class="block text-slate-500">Período ($P$)</span><span class="font-semibold">${st.traffic.P} anos</span></div><div><span class="block text-slate-500">Fator Veículo ($FV$)</span><span class="font-semibold">${st.traffic.FV}</span></div><div><span class="block text-slate-500">Número N</span><span class="font-bold text-dnit-600">${formatScientific(st.traffic.calculatedN)}</span></div></div></section><section><h3 class="text-lg font-bold text-dnit-800 border-b border-dnit-100 pb-2 mb-4">2. Estrutura do Pavimento</h3><div class="space-y-2"><p class="text-sm text-slate-600"><strong>Subleito:</strong> CBR ${st.soil.subgradeCBR}% | Expansão ${st.soil.expansion}%</p></div></section><section><h3 class="text-lg font-bold text-dnit-800 border-b border-dnit-100 pb-2 mb-4">3. Drenagem</h3><p class="text-sm text-slate-600">Área <strong>${st.drainage.area} m²</strong>, C=<strong>${st.drainage.c}</strong>, chuva <strong>${st.drainage.rainfall_i} mm/h</strong>.</p></section></div><div class="mt-12 pt-6 border-t border-slate-200 flex justify-end"><button id="btn-pdf" class="bg-dnit-600 hover:bg-dnit-700 text-white px-4 py-2 rounded shadow flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Gerar PDF</button></div></div>`; if(window.lucide) lucide.createIcons(); const btn=document.getElementById('btn-pdf'); if(btn) btn.addEventListener('click', ()=>{ if(!window.jspdf){ return; } const { jsPDF } = window.jspdf; const doc=new jsPDF(); doc.text("Relatório Pavimentação.br",20,20); doc.save("relatorio-pavimentacao.pdf"); }); }

  const routes={ traffic:{ title:'Tráfego', icon:'car', render:renderTraffic }, soil:{ title:'Solo e Leito', icon:'shovel', render:renderSoil }, structure:{ title:'Estrutura', icon:'layers', render:renderStructure }, drainage:{ title:'Drenagem', icon:'cloud-rain', render:renderDrainage }, report:{ title:'Relatório', icon:'file-text', render:renderReport } };
  function renderSidebar(){ const nav=document.getElementById('sidebar-nav'); if(!nav) return; nav.innerHTML = Object.entries(routes).map(([key,route])=> `<button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-all group" data-route="${key}"><i data-lucide="${route.icon}" class="w-5 h-5 text-slate-400 group-hover:text-dnit-500"></i>${route.title}</button>` ).join(''); if(window.lucide) lucide.createIcons(); nav.querySelectorAll('.nav-item').forEach(btn=>{ btn.addEventListener('click', ()=> navigate(btn.dataset.route)); }); }
  function navigate(key){ const r=routes[key]; if(!r) return; document.querySelectorAll('.nav-item').forEach(el=>{ if(el.dataset.route===key){ el.classList.add('bg-dnit-50','text-dnit-600','border-r-4','border-dnit-600'); el.classList.remove('text-slate-600','hover:bg-slate-50'); } else { el.classList.remove('bg-dnit-50','text-dnit-600','border-r-4','border-dnit-600'); el.classList.add('text-slate-600','hover:bg-slate-50'); } }); const container=document.getElementById('app-container'); if(!container) return; container.innerHTML='<div class="flex items-center justify-center h-full text-slate-400">Carregando...</div>'; const title=document.getElementById('page-title'); if(title) title.innerText=r.title; r.render(container); }

  document.addEventListener('DOMContentLoaded',()=>{ try{ renderSidebar(); navigate('traffic'); const btn=document.getElementById('btn-save'); if(btn) btn.addEventListener('click', ()=>{ const data=JSON.stringify(store.getState(), null, 2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pavimentacao_br_${new Date().getTime()}.json`; a.click(); }); }catch(e){ console.error('Pavimentação init error', e); } });
})();