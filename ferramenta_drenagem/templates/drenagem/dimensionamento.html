{% extends 'layouts/app.html' %}
{% load static %}

{% block title %}{{ title }} - Resolve Eng{% endblock %}

{% block page_title %}Dimensionamento Hidráulico{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles for the calculator */
    .dimensionamento-layout {
        padding: 0;
    }
    .calc-card {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2);
        transition: transform 0.2s ease;
        background: var(--color-surface);
        margin-bottom: 20px;
    }

    .calc-card .card-body {
        padding: var(--space-5);
    }

    @media (max-width: 575px) {
        .calc-card .card-body {
            padding: var(--space-4) var(--space-3);
        }
    }

    .calc-header {
        background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%);
        color: white;
        padding: 20px;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .form-label {
        font-weight: 500;
        color: var(--color-text);
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: var(--color-surface-alt);
        border-color: var(--color-border);
        color: var(--color-text-soft);
        font-size: 0.85rem;
    }

    .result-box {
        background-color: var(--color-surface-alt);
        border-radius: var(--radius-md);
        padding: 15px;
        border-left: 4px solid var(--color-primary);
        margin-top: 15px;
    }

    .result-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-primary);
    }

    .result-label {
        font-size: 0.85rem;
        color: var(--color-text-soft);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .method-badge {
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 4px;
        background-color: var(--color-surface-alt);
        color: var(--color-text);
        margin-left: 8px;
    }

    /* Print Styles */
    @media print {

        .sidebar,
        .top-header,
        .btn-no-print,
        footer {
            display: none !important;
        }

        .content-body {
            margin: 0 !important;
            padding: 0 !important;
        }

        .calc-card {
            box-shadow: none !important;
            border: 1px solid #dee2e6 !important;
            break-inside: avoid;
        }

        .card-body {
            padding: 10px !important;
        }

        body {
            background-color: white !important;
        }
    }

    .nav-pills .nav-link {
        color: var(--color-text);
        border-radius: var(--radius-md);
        padding: 10px 20px;
    }

    .nav-pills .nav-link.active {
        background-color: var(--color-primary);
        color: white;
    }

    .diagram-container {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--color-surface-alt);
        border-radius: var(--radius-md);
        margin-bottom: 15px;
        overflow: hidden;
        position: relative;
    }

    .method-selector .btn-check:checked + .btn {
        border-color: var(--color-primary);
        background-color: rgba(var(--color-primary-rgb), 0.08);
        color: var(--color-primary);
    }

    .method-selector select:disabled {
        background-color: var(--color-surface-alt);
    }

    .method-highlight {
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }

    .method-highlight.active-row {
        background-color: rgba(var(--color-primary-rgb), 0.08) !important;
        box-shadow: inset 0 0 0 2px rgba(var(--color-primary-rgb), 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-full dimensionamento-layout py-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">Dimensionamento Hidráulico</h1>
            <p class="text-muted mb-0">Configure parâmetros e acompanhe resultados em tempo real.</p>
        </div>
        <button onclick="window.print()" class="btn btn-outline-secondary btn-no-print align-self-lg-center">
            <i class="bi bi-printer me-2"></i>Imprimir Memória
        </button>
    </div>

    <div class="row g-4">
        <!-- Input Section -->
        <div class="col-lg-5">
            <div class="calc-card">
                <div class="calc-header">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Dados de Entrada</h5>
                </div>
                <div class="card-body">
                    <form id="calcForm">
                        <!-- Hydrology -->
                        <h6 class="text-primary mb-3 border-bottom pb-2">Hidrologia (Método Racional)</h6>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Área de Contribuição (A)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="area" value="10" step="0.01">
                                    <select class="form-select" id="area-unit" style="max-width: 85px;">
                                        <option value="ha" selected>ha</option>
                                        <option value="m2">m²</option>
                                        <option value="km2">km²</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Coef. Runoff (C) - Racional</label>
                                <input type="number" class="form-control" id="runoff" value="0.60" step="0.01" max="1"
                                    min="0">
                                <div class="form-text" style="font-size: 0.75rem;">Ex: 0.90 (Impermeável), 0.30 (Verde)
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Hydrology Inputs -->
                        <div class="accordion mb-3" id="advancedHydro">
                            <div class="accordion-item border-0 shadow-sm">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2 bg-light text-secondary"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                        <i class="bi bi-gear me-2"></i>Parâmetros Avançados (I-Pai-Wu / SCS)
                                    </button>
                                </h2>
                                <div id="collapseAdvanced" class="accordion-collapse collapse"
                                    data-bs-parent="#advancedHydro">
                                    <div class="accordion-body bg-light rounded-bottom">
                                        <h6 class="text-primary small fw-bold">Método I-Pai-Wu</h6>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label class="form-label small">Coef. Forma (C2)</label>
                                                <input type="number" class="form-control form-control-sm" id="ipaiwu-c2"
                                                    value="0.5">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">Fator Distribuição (K)</label>
                                                <input type="number" class="form-control form-control-sm" id="ipaiwu-k"
                                                    value="0.9">
                                            </div>
                                        </div>

                                        <h6 class="text-primary small fw-bold">Método SCS (CN)</h6>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <label class="form-label small">Curve Number (CN)</label>
                                                <input type="number" class="form-control form-control-sm" id="scs-cn"
                                                    value="75" max="100">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">Abstração (Ia/S)</label>
                                                <input type="number" class="form-control form-control-sm"
                                                    id="scs-lambda" value="0.2" step="0.05">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Tempo de Retorno (TR)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="tr" value="10" step="1">
                                    <span class="input-group-text">anos</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Equação de Chuva</label>
                                <button type="button" class="btn btn-outline-primary btn-sm w-100"
                                    data-bs-toggle="modal" data-bs-target="#rainModal">
                                    Configurar (Nova Petrópolis)
                                </button>
                            </div>
                        </div>

                        <!-- Geometry -->
                        <h6 class="text-primary mb-3 border-bottom pb-2 mt-4">Geometria do Talvegue</h6>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Comprimento (L)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="length" value="500" step="1">
                                    <span class="input-group-text">m</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Desnível (ΔH)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="deltaH" value="5" step="0.1">
                                    <span class="input-group-text">m</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Declividade Calculada (S)</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-light" id="slope" readonly>
                                <span class="input-group-text">m/m</span>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-lg-7">
            <!-- Hydrology Results -->
            <!-- Hydrology Results -->
            <div class="calc-card mb-4 p-3">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.8rem; letter-spacing: 1px;">
                        Resultados Hidrológicos (Comparativo)</h6>

                    <div class="table-responsive">
                        <table class="table table-hover table-bordered text-center align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Método</th>
                                    <th>Q de Projeto (m³/s)</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-method-row="rational" class="method-highlight">
                                    <td class="fw-bold text-primary">Racional</td>
                                    <td><span id="res-q-rational" class="fs-5 fw-bold">--</span></td>
                                    <td class="small text-muted">Q = CIA/360</td>
                                </tr>
                                <tr data-method-row="ipaiwu" class="method-highlight">
                                    <td class="fw-bold text-info">I-Pai-Wu</td>
                                    <td><span id="res-q-ipaiwu" class="fs-5 fw-bold">--</span></td>
                                    <td class="small text-muted">Q = 0.278 * C * i * A^0.9 * K</td>
                                </tr>
                                <tr data-method-row="scs" class="method-highlight">
                                    <td class="fw-bold text-success">SCS (CN)</td>
                                    <td><span id="res-q-scs" class="fs-5 fw-bold">--</span></td>
                                    <td class="small text-muted">Qp (HUT)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="method-selector mt-3">
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <div class="btn-group" role="group" aria-label="Modo de dimensionamento">
                                <input type="radio" class="btn-check" name="dimensioning-mode" id="mode-auto"
                                    value="auto" checked>
                                <label class="btn btn-outline-secondary" for="mode-auto">Maior vazão</label>

                                <input type="radio" class="btn-check" name="dimensioning-mode" id="mode-manual"
                                    value="manual">
                                <label class="btn btn-outline-secondary" for="mode-manual">Escolher método</label>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select" id="method-select" style="min-width: 190px;"
                                    disabled>
                                    <option value="rational">Racional</option>
                                    <option value="ipaiwu">I-Pai-Wu</option>
                                    <option value="scs">SCS (CN)</option>
                                </select>
                                <span class="badge bg-light text-dark border"><span class="fw-semibold"
                                        id="method-mode-label">Automático</span></span>
                            </div>

                            <div class="ms-auto">
                                <span class="badge bg-primary-subtle text-primary border border-primary">
                                    Método em uso: <span id="method-active-label" class="fw-semibold">--</span>
                                </span>
                                <span class="badge bg-success-subtle text-success border border-success ms-2">
                                    Q selecionado: <span id="method-active-flow">--</span> m³/s
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row text-center mt-3 pt-3 border-top">
                        <div class="col-md-6 border-end">
                            <div class="result-label">Tempo de Concentração (tc)</div>
                            <div class="result-value" id="res-tc">--</div>
                            <small class="text-muted">min</small>
                        </div>
                        <div class="col-md-6">
                            <div class="result-label">Intensidade (I)</div>
                            <div class="result-value" id="res-i">--</div>
                            <small class="text-muted">mm/h</small>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3 mb-0 py-2 small">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        A vazão utilizada para o dimensionamento abaixo acompanha o método destacado acima.
                    </div>
                </div>
            </div>

            <!-- Hydraulics Sizing -->
            <div class="calc-card">
                <div class="calc-header bg-secondary">
                    <h5 class="mb-0"><i class="bi bi-bounding-box me-2"></i>Dimensionamento da Seção</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-pipe-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-pipe" type="button" role="tab">Tubulação</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-box-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-box" type="button" role="tab">Galeria Celular</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-channel-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-channel" type="button" role="tab">Canal Aberto</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">

                        <!-- Pipe Sizing -->
                        <div class="tab-pane fade show active" id="pills-pipe" role="tabpanel">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <label class="form-label">Coef. Rugosidade (n)</label>
                                    <input type="number" class="form-control mb-3" id="n-pipe" value="0.013"
                                        step="0.001">

                                    <div class="result-box">
                                        <div class="result-label">Diâmetro Necessário (Teórico)</div>
                                        <div class="result-value" id="res-d-theo">--</div>
                                        <small class="text-muted">m (Seção Plena)</small>
                                    </div>

                                    <div class="mt-3">
                                        <div class="row g-3">
                                            <div class="col-sm-6">
                                                <label class="form-label">Quantidade de Tubos</label>
                                                <input type="number" class="form-control" id="pipe-count" value="1"
                                                    min="1" max="99">
                                            </div>
                                            <div class="col-sm-6">
                                                <label class="form-label">Diâmetro Comercial</label>
                                                <select class="form-select" id="pipe-diameter"></select>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-2">Sugestão automática:
                                            <span class="fw-semibold" id="pipe-suggestion">--</span></small>
                                        <div class="result-box mt-3" style="background:var(--color-surface-alt);">
                                            <div class="result-label">Capacidade da Configuração Comercial</div>
                                            <div class="result-value" id="res-pipe-capacity">--</div>
                                            <small class="text-muted">m³/s disponíveis | Necessário:
                                                <span id="pipe-q-needed">--</span> | Diâmetro selecionado:
                                                <span id="res-d-comm">--</span></small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="diagram-container">
                                        <!-- Simple SVG representation -->
                                        <svg width="150" height="150" viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="#e9ecef" stroke="#6c757d"
                                                stroke-width="2" />
                                            <path d="M 50 95 A 45 45 0 0 1 50 95" fill="#0d6efd" opacity="0.5"
                                                id="water-level-pipe" />
                                            <text x="50" y="55" text-anchor="middle" font-size="12" fill="#495057">D =
                                                <tspan id="svg-d">--</tspan>
                                            </text>
                                        </svg>
                                    </div>
                                    <small class="text-muted">Seção Circular</small>
                                </div>
                            </div>
                        </div>

                        <!-- Box Culvert Sizing -->
                        <div class="tab-pane fade" id="pills-box" role="tabpanel">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <label class="form-label">Coef. Rugosidade (n)</label>
                                    <input type="number" class="form-control mb-3" id="n-box" value="0.015"
                                        step="0.001">

                                    <label class="form-label">Base Fixada (B)</label>
                                    <div class="input-group mb-3">
                                        <input type="number" class="form-control" id="box-base" value="2.0" step="0.5">
                                        <span class="input-group-text">m</span>
                                    </div>

                                    <label class="form-label">Altura Útil (H)</label>
                                    <div class="input-group mb-3">
                                        <input type="number" class="form-control" id="box-height" value="1.5" step="0.5">
                                        <span class="input-group-text">m</span>
                                    </div>

                                    <label class="form-label">Seção Comercial</label>
                                    <select class="form-select mb-2" id="box-commercial">
                                        <option value="custom">Personalizar dimensões</option>
                                    </select>
                                    <small class="text-muted">Sugestão automática:
                                        <span class="fw-semibold" id="box-suggestion">--</span></small>

                                    <div class="result-box">
                                        <div class="result-label">Altura d'água (y)</div>
                                        <div class="result-value" id="res-box-h">--</div>
                                        <small class="text-muted">m (Regime Uniforme)</small>
                                    </div>

                                    <div class="result-box mt-3" style="background:var(--color-surface-alt);">
                                        <div class="result-label">Capacidade da Seção Comercial</div>
                                        <div class="result-value" id="res-box-capacity">--</div>
                                        <small class="text-muted">m³/s disponíveis | Necessário:
                                            <span id="box-q-needed">--</span></small>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="diagram-container">
                                        <svg width="180" height="120" viewBox="0 0 180 120">
                                            <rect x="10" y="10" width="160" height="100" fill="none" stroke="#6c757d"
                                                stroke-width="2" />
                                            <rect x="10" y="80" width="160" height="30" fill="#0d6efd" opacity="0.5"
                                                id="water-level-box" />
                                            <text x="90" y="130" text-anchor="middle" font-size="12" fill="#495057">B =
                                                <tspan id="svg-box-b">--</tspan>
                                            </text>
                                        </svg>
                                    </div>
                                    <small class="text-muted">Galeria Retangular</small>
                                </div>
                            </div>
                        </div>

                        <!-- Channel Sizing -->
                        <div class="tab-pane fade" id="pills-channel" role="tabpanel">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <label class="form-label">Coef. Rugosidade (n)</label>
                                    <input type="number" class="form-control mb-3" id="n-channel" value="0.025"
                                        step="0.001">

                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label">Base (b)</label>
                                            <input type="number" class="form-control" id="channel-b" value="3.0"
                                                step="0.5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Talude (z)</label>
                                            <input type="number" class="form-control" id="channel-z" value="1.5"
                                                step="0.1">
                                            <div class="form-text" style="font-size: 0.7rem;">H:V (z:1)</div>
                                        </div>
                                    </div>

                                    <div class="result-box mt-3">
                                        <div class="result-label">Altura Normal (yn)</div>
                                        <div class="result-value" id="res-channel-y">--</div>
                                        <small class="text-muted">m</small>
                                    </div>
                                </div>
                                <div class="col-md-6 text-center">
                                    <div class="diagram-container">
                                        <svg width="180" height="120" viewBox="0 0 180 120">
                                            <!-- Trapezoid -->
                                            <polyline points="10,10 50,110 130,110 170,10" fill="none" stroke="#6c757d"
                                                stroke-width="2" />
                                            <!-- Water -->
                                            <path d="M 30 60 L 50 110 L 130 110 L 150 60 Z" fill="#0d6efd" opacity="0.5"
                                                id="water-level-channel" />
                                        </svg>
                                    </div>
                                    <small class="text-muted">Canal Trapezoidal</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rain Modal -->
<div class="modal fade" id="rainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Parâmetros da Chuva (IDF)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="rainTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="select-tab" data-bs-toggle="tab"
                            data-bs-target="#select-pane" type="button" role="tab">Selecionar Cidade</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-tab" data-bs-toggle="tab" data-bs-target="#new-pane"
                            type="button" role="tab">Nova Equação</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Select Pane -->
                    <div class="tab-pane fade show active" id="select-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Cidade / Localidade</label>
                            <select class="form-select" id="city-select">
                                {% for eq in equations %}
                                <option value="{{ eq.id }}" data-k="{{ eq.k }}" data-a="{{ eq.a }}" data-b="{{ eq.b }}"
                                    data-c="{{ eq.c }}" {% if default_eq and default_eq.id == eq.id %}selected{% endif %}>{{ eq.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <hr>
                        <p class="small text-muted">Equação: i = K * TR^a / (t + b)^c</p>
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <label class="form-label">K</label>
                                <input type="number" class="form-control" id="rain-k">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">a</label>
                                <input type="number" class="form-control" id="rain-a">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">b</label>
                                <input type="number" class="form-control" id="rain-b">
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="form-label">c</label>
                                <input type="number" class="form-control" id="rain-c">
                            </div>
                        </div>
                    </div>

                    <!-- New Pane -->
                    <div class="tab-pane fade" id="new-pane" role="tabpanel">
                        <form id="new-eq-form">
                            <div class="mb-3">
                                <label class="form-label">Nome da Cidade / Localidade</label>
                                <input type="text" class="form-control" id="new-name" required>
                            </div>
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <label class="form-label">K</label>
                                    <input type="number" class="form-control" id="new-k" required step="any">
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label">a</label>
                                    <input type="number" class="form-control" id="new-a" required step="any">
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label">b</label>
                                    <input type="number" class="form-control" id="new-b" required step="any">
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label">c</label>
                                    <input type="number" class="form-control" id="new-c" required step="any">
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-1"></i> Adicionar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Usar Parâmetros</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const PIPE_DIAMETERS = [0.40, 0.60, 0.80, 1.00, 1.20, 1.50, 1.80, 2.00];
        const BOX_SECTIONS = [
            { label: '1,50 x 1,50 m', width: 1.50, height: 1.50 },
            { label: '1,60 x 1,60 m', width: 1.60, height: 1.60 },
            { label: '1,70 x 1,70 m', width: 1.70, height: 1.70 },
            { label: '1,50 x 2,00 m', width: 1.50, height: 2.00 },
            { label: '2,00 x 2,00 m', width: 2.00, height: 2.00 },
            { label: '2,00 x 2,50 m', width: 2.00, height: 2.50 },
            { label: '2,50 x 2,50 m', width: 2.50, height: 2.50 },
            { label: '2,50 x 3,00 m', width: 2.50, height: 3.00 },
            { label: '3,00 x 3,00 m', width: 3.00, height: 3.00 },
            { label: '3,00 x 3,50 m', width: 3.00, height: 3.50 },
            { label: '3,50 x 3,50 m', width: 3.50, height: 3.50 },
            { label: '3,50 x 4,00 m', width: 3.50, height: 4.00 },
            { label: '4,00 x 4,00 m', width: 4.00, height: 4.00 }
        ];

        const pipeDiameterSelect = document.getElementById('pipe-diameter');
        const pipeCountInput = document.getElementById('pipe-count');
        const boxCommercialSelect = document.getElementById('box-commercial');
        const boxBaseInput = document.getElementById('box-base');
        const boxHeightInput = document.getElementById('box-height');

        let pipeSelectManual = false;
        let boxSelectManual = false;
        // Evita reaplicar sugestão comercial em loop (guard)
        let boxAutoApplied = false;

        const inputs = document.querySelectorAll('#calcForm input, #calcForm select, #pills-tabContent input, #pills-tabContent select');
        const modeRadios = document.querySelectorAll('input[name="dimensioning-mode"]');
        const methodSelect = document.getElementById('method-select');
        const methodBadge = document.getElementById('method-active-label');
        const methodFlowBadge = document.getElementById('method-active-flow');
        const modeLabel = document.getElementById('method-mode-label');
        const methodRows = document.querySelectorAll('[data-method-row]');
        const modeManual = document.getElementById('mode-manual');
        const modeAuto = document.getElementById('mode-auto');
        populateCommercialOptions();

        // Helper function to convert area to hectares
        function getAreaInHectares() {
            const areaValue = parseFloat(document.getElementById('area').value) || 0;
            const areaUnit = document.getElementById('area-unit').value;
            
            // Convert to hectares based on selected unit
            // 1 ha = 10,000 m², 1 km² = 100 ha
            switch (areaUnit) {
                case 'm2':
                    return areaValue / 10000;
                case 'km2':
                    return areaValue * 100;
                case 'ha':
                default:
                    return areaValue;
            }
        }

        inputs.forEach(input => {
            input.addEventListener('input', calculateAll);
            input.addEventListener('change', calculateAll);
        });

        // Explicit listener for area unit change (also covered by inputs.forEach above)
        const areaUnitSelect = document.getElementById('area-unit');
        if (areaUnitSelect) {
            areaUnitSelect.addEventListener('change', calculateAll);
        }

        if (pipeCountInput) {
            pipeCountInput.addEventListener('input', () => {
                clampPipeCount();
                calculateAll();
            });
        }
        if (pipeDiameterSelect) {
            pipeDiameterSelect.addEventListener('change', () => {
                if (pipeDiameterSelect.dataset.internalUpdate) {
                    delete pipeDiameterSelect.dataset.internalUpdate;
                } else {
                    pipeSelectManual = true;
                }
                calculateAll();
            });
        }
        if (boxCommercialSelect) {
            boxCommercialSelect.addEventListener('change', () => {
                const option = boxCommercialSelect.selectedOptions[0];
                if (option && boxCommercialSelect.value !== 'custom') {
                    boxBaseInput.value = option.dataset.width;
                    boxHeightInput.value = option.dataset.height;
                }
                if (boxCommercialSelect.dataset.internalUpdate) {
                    delete boxCommercialSelect.dataset.internalUpdate;
                } else {
                    boxSelectManual = true;
                }
                calculateAll();
            });
        }
        [boxBaseInput, boxHeightInput].forEach(el => {
            if (el) {
                el.addEventListener('input', () => {
                    boxSelectManual = true;
                    calculateAll();
                });
            }
        });
        modeRadios.forEach(radio => radio.addEventListener('change', () => {
            handleModeChange();
            calculateAll();
        }));
        if (methodSelect) {
            methodSelect.addEventListener('change', calculateAll);
        }

        handleModeChange();
        calculateAll();

        function handleModeChange() {
            const manual = modeManual && modeManual.checked;
            if (methodSelect) {
                methodSelect.disabled = !manual;
                methodSelect.classList.toggle('opacity-50', !manual);
            }
            if (modeLabel) {
                modeLabel.textContent = manual ? 'Manual' : 'Automático';
            }
        }

        function calculateAll() {
            const inputsExist = ['area', 'runoff', 'tr', 'length', 'deltaH', 'rain-k', 'rain-a', 'rain-b', 'rain-c'];
            const missing = inputsExist.some(id => !document.getElementById(id));
            if (missing) {
                return;
            }

            const A = getAreaInHectares();
            const C = parseFloat(document.getElementById('runoff').value) || 0;
            const TR = parseFloat(document.getElementById('tr').value) || 0;
            const L = parseFloat(document.getElementById('length').value) || 0;
            const dH = parseFloat(document.getElementById('deltaH').value) || 0;

            const K = parseFloat(document.getElementById('rain-k').value) || 0;
            const a = parseFloat(document.getElementById('rain-a').value) || 0;
            const b = parseFloat(document.getElementById('rain-b').value) || 0;
            const c = parseFloat(document.getElementById('rain-c').value) || 0;

            let S = 0;
            if (L > 0) {
                S = dH / L;
            }
            document.getElementById('slope').value = S > 0 ? S.toFixed(4) : '--';

            let tc = 10;
            if (L > 0 && S > 0) {
                tc = 0.0195 * Math.pow(L, 0.77) * Math.pow(S, -0.385);
            }
            tc = Math.max(tc, 10);
            setText('res-tc', tc, 1);

            let I = 0;
            if (tc > 0) {
                I = (K * Math.pow(TR, a)) / Math.pow(tc + b, c || 1);
            }
            setText('res-i', I);

            const flows = calculateFlows({ A, C, I, tc });
            const activeMethod = resolveActiveMethod(flows);
            updateMethodUI(activeMethod, flows[activeMethod]?.value || 0);
            highlightMethodRow(activeMethod);

            const Q_design = flows[activeMethod]?.value || 0;
            if (Q_design > 0 && S > 0) {
                calcPipe(Q_design, S);
                calcBox(Q_design, S);
                calcChannel(Q_design, S);
            } else {
                resetHydraulicOutputs();
            }
        }

        function calculateFlows({ A, C, I, tc }) {
            const flows = {
                rational: { label: 'Racional', value: 0 },
                ipaiwu: { label: 'I-Pai-Wu', value: 0 },
                scs: { label: 'SCS (CN)', value: 0 }
            };

            if (A > 0) {
                flows.rational.value = (C * I * A) / 360;
            }
            setText('res-q-rational', flows.rational.value, 3);

            const C2 = parseFloat(document.getElementById('ipaiwu-c2').value) || 0.5;
            const K_dist = parseFloat(document.getElementById('ipaiwu-k').value) || 1.0;
            if (A > 0) {
                const A_km2 = A / 100;
                flows.ipaiwu.value = 0.278 * C2 * I * Math.pow(A_km2, 0.9) * K_dist;
            }
            setText('res-q-ipaiwu', flows.ipaiwu.value, 3);

            const CN = parseFloat(document.getElementById('scs-cn').value) || 75;
            const lambda = parseFloat(document.getElementById('scs-lambda').value) || 0.2;
            if (A > 0 && tc > 0) {
                const S_scs = (25400 / CN) - 254;
                const Ia = lambda * S_scs;
                const P_total = I * (tc / 60);
                let Pe = 0;
                if (P_total > Ia) {
                    Pe = Math.pow(P_total - Ia, 2) / (P_total - Ia + S_scs);
                }
                const Tc_h = tc / 60;
                const Tp_h = 0.6 * Tc_h + (Tc_h / 2);
                const A_km2 = A / 100;
                if (Tp_h > 0) {
                    const q_unit = (2.08 * A_km2) / Tp_h;
                    flows.scs.value = q_unit * Pe;
                }
            }
            setText('res-q-scs', flows.scs.value, 3);

            return flows;
        }

        function resolveActiveMethod(flows) {
            const available = Object.keys(flows).filter(key => flows[key].value > 0);
            if (!available.length) {
                return 'rational';
            }

            if (modeManual && modeManual.checked && methodSelect) {
                const chosen = methodSelect.value;
                if (flows[chosen]?.value > 0) {
                    return chosen;
                }
            }

            return available.reduce((best, key) => flows[key].value > flows[best].value ? key : best, available[0]);
        }

        function updateMethodUI(methodKey, flowValue) {
            if (methodBadge) {
                methodBadge.textContent = methodKey ? {
                    rational: 'Racional',
                    ipaiwu: 'I-Pai-Wu',
                    scs: 'SCS (CN)'
                }[methodKey] : '--';
            }
            if (methodFlowBadge) {
                methodFlowBadge.textContent = flowValue > 0 ? flowValue.toFixed(3) : '--';
            }
            if (methodSelect && (!modeManual || !modeManual.checked)) {
                methodSelect.value = methodKey;
            }
        }

        function highlightMethodRow(methodKey) {
            methodRows.forEach(row => {
                row.classList.toggle('active-row', row.dataset.methodRow === methodKey);
            });
        }

        function calcPipe(Q, S) {
            const n = parseFloat(document.getElementById('n-pipe').value) || 0.013;
            if (Q <= 0 || S <= 0 || n <= 0) {
                setText('res-d-theo', 0);
                updatePipeDiameterSvg(0);
                updatePipeSuggestionDisplay();
                updatePipeCapacityDisplay({ diameterSelected: 0, n, S, count: 0, Q: 0 });
                return;
            }

            const count = clampPipeCount();
            const Q_target = Q / count;
            const D_theo = Math.pow((Q_target * n) / (0.3117 * Math.sqrt(S)), 0.375);
            setText('res-d-theo', D_theo, 3);
            updatePipeDiameterSvg(D_theo);

            const suggestion = PIPE_DIAMETERS.find(d => d >= D_theo) || PIPE_DIAMETERS[PIPE_DIAMETERS.length - 1];
            updatePipeSuggestionDisplay(suggestion);
            ensurePipeSelectionValue(suggestion);

            const selectedValue = pipeDiameterSelect ? parseFloat(pipeDiameterSelect.value) : suggestion;
            updatePipeCapacityDisplay({
                diameterSelected: selectedValue || 0,
                n,
                S,
                count,
                Q
            });
        }

        function clampPipeCount() {
            if (!pipeCountInput) {
                return 1;
            }
            let count = parseInt(pipeCountInput.value, 10);
            if (isNaN(count)) {
                count = 1;
            }
            count = Math.min(99, Math.max(1, count));
            pipeCountInput.value = count;
            return count;
        }

        function updatePipeDiameterSvg(value) {
            const svgText = document.getElementById('svg-d');
            if (svgText) {
                svgText.textContent = value && value > 0 ? `${value.toFixed(2)}m` : '--';
            }
        }

        function updatePipeSuggestionDisplay(diameter) {
            const el = document.getElementById('pipe-suggestion');
            if (el) {
                el.textContent = diameter ? `${diameter.toFixed(2)} m` : 'Sob medida';
            }
        }

        function ensurePipeSelectionValue(diameter) {
            if (!pipeDiameterSelect || pipeSelectManual || !diameter) {
                return;
            }
            const formatted = diameter.toFixed(2);
            if (pipeDiameterSelect.value === formatted) {
                return;
            }
            pipeDiameterSelect.dataset.internalUpdate = '1';
            pipeDiameterSelect.value = formatted;
            pipeDiameterSelect.dispatchEvent(new Event('change'));
        }

        function updatePipeCapacityDisplay({ diameterSelected, n, S, count, Q }) {
            const neededEl = document.getElementById('pipe-q-needed');
            if (neededEl) {
                neededEl.textContent = Q && Q > 0 ? Q.toFixed(3) : '--';
            }
            if (!document.getElementById('res-pipe-capacity')) {
                return;
            }
            if (!diameterSelected || diameterSelected <= 0 || S <= 0 || n <= 0 || count <= 0) {
                setText('res-pipe-capacity', 0);
                setPipeSelectedLabel('--');
                return;
            }
            const capacityPerPipe = manningCircular(diameterSelected, n, S);
            const totalCapacity = capacityPerPipe * count;
            setText('res-pipe-capacity', totalCapacity, 3);
            setPipeSelectedLabel(`${diameterSelected.toFixed(2)} m`);
        }

        function setPipeSelectedLabel(text) {
            const el = document.getElementById('res-d-comm');
            if (el) {
                el.textContent = text || '--';
            }
        }

        function calcBox(Q, S) {
            const n = parseFloat(document.getElementById('n-box').value) || 0.015;
            const B = parseFloat(boxBaseInput.value) || 0;
            const H = parseFloat(boxHeightInput.value) || 0;
            if (Q <= 0 || S <= 0 || n <= 0 || B <= 0 || H <= 0) {
                setText('res-box-h', 0);
                updateBoxSuggestion(0, S, n);
                return;
            }

            let y = Math.min(H, 0.5);
            for (let i = 0; i < 25; i++) {
                const A = B * y;
                const P = B + 2 * y;
                const R = A / P;
                const Q_calc = (1 / n) * A * Math.pow(R, 2 / 3) * Math.sqrt(S);
                if (!isFinite(Q_calc) || Q_calc <= 0) {
                    break;
                }
                const ratio = Q / Q_calc;
                if (Math.abs(1 - ratio) < 0.001) {
                    break;
                }
                y *= Math.pow(ratio, 0.6);
                y = Math.min(y, H);
            }

            setText('res-box-h', y, 2);
            document.getElementById('svg-box-b').textContent = `${B.toFixed(1)}m`;
            updateBoxSuggestion(Q, S, n);
        }

        function updateBoxSuggestion(Q, S, n) {
            const suggestionEl = document.getElementById('box-suggestion');
            const neededEl = document.getElementById('box-q-needed');
            if (neededEl) {
                neededEl.textContent = Q && Q > 0 ? Q.toFixed(3) : '--';
            }
            if (!Q || Q <= 0 || !S || S <= 0 || !n || n <= 0) {
                if (suggestionEl) {
                    suggestionEl.textContent = 'Sob medida';
                }
                setText('res-box-capacity', 0);
                return;
            }

            const suggestion = BOX_SECTIONS.find(section => rectangularCapacity(section.width, section.height, n, S) >= Q);
            if (suggestionEl) {
                suggestionEl.textContent = suggestion ? suggestion.label : 'Sob medida';
            }
            // Só dispara uma vez automaticamente; evita loop recursivo calculo -> sugestão -> change -> calculo
            if (suggestion && boxCommercialSelect && !boxSelectManual && !boxAutoApplied) {
                const newVal = `${suggestion.width}x${suggestion.height}`;
                if (boxCommercialSelect.value !== newVal) {
                    boxCommercialSelect.dataset.internalUpdate = '1';
                    boxCommercialSelect.value = newVal;
                    boxCommercialSelect.dispatchEvent(new Event('change'));
                }
                boxAutoApplied = true; // marca que já aplicamos automaticamente
            }

            const dims = getActiveBoxDimensions();
            const capacity = rectangularCapacity(dims.width, dims.height, n, S);
            setText('res-box-capacity', capacity, 3);
        }

        function getActiveBoxDimensions() {
            return {
                width: parseFloat(boxBaseInput.value) || 0,
                height: parseFloat(boxHeightInput.value) || 0
            };
        }

        function calcChannel(Q, S) {
            const n = parseFloat(document.getElementById('n-channel').value) || 0.025;
            const b = parseFloat(document.getElementById('channel-b').value) || 3.0;
            const z = parseFloat(document.getElementById('channel-z').value) || 1.5;
            if (Q <= 0 || S <= 0 || n <= 0 || b <= 0) {
                setText('res-channel-y', 0);
                updateChannelSvg(0, z);
                return;
            }

            let y = 0.5;
            for (let i = 0; i < 30; i++) {
                const topWidth = b + 2 * z * y;
                const area = y * (b + z * y);
                const perimeter = b + 2 * y * Math.sqrt(1 + z * z);
                const R = area / perimeter;
                const Q_calc = (1 / n) * area * Math.pow(R, 2 / 3) * Math.sqrt(S);
                if (!isFinite(Q_calc) || Q_calc <= 0) {
                    break;
                }
                const ratio = Q / Q_calc;
                if (Math.abs(1 - ratio) < 0.001) {
                    break;
                }
                y *= Math.pow(ratio, 0.6);
            }

            setText('res-channel-y', y, 2);
            updateChannelSvg(y, z);
        }

        function updateChannelSvg(y, z) {
            const water = document.getElementById('water-level-channel');
            if (!water) {
                return;
            }
            const maxDepth = 5;
            const depth = Math.max(0, Math.min(y, maxDepth));
            const baseY = 110;
            const minY = 30;
            const heightPx = (depth / maxDepth) * (baseY - minY);
            const topY = baseY - heightPx;
            const spread = 20 + (depth / maxDepth) * 25 * (z / 1.5);
            const leftTopX = 90 - spread;
            const rightTopX = 90 + spread;
            const path = `M ${leftTopX} ${topY} L ${50} 110 L 130 110 L ${rightTopX} ${topY} Z`;
            water.setAttribute('d', path);
        }

        function manningCircular(diameter, n, S) {
            if (!diameter || diameter <= 0 || !n || n <= 0 || !S || S <= 0) {
                return 0;
            }
            const area = Math.PI * Math.pow(diameter, 2) / 4;
            const perimeter = Math.PI * diameter;
            const R = area / perimeter;
            return (1 / n) * area * Math.pow(R, 2 / 3) * Math.sqrt(S);
        }

        function rectangularCapacity(width, height, n, S) {
            if (!width || !height || width <= 0 || height <= 0 || !n || n <= 0 || !S || S <= 0) {
                return 0;
            }
            const area = width * height;
            const perimeter = 2 * (width + height);
            const R = area / perimeter;
            return (1 / n) * area * Math.pow(R, 2 / 3) * Math.sqrt(S);
        }

        function populateCommercialOptions() {
            if (pipeDiameterSelect && pipeDiameterSelect.options.length === 0) {
                PIPE_DIAMETERS.forEach(diameter => {
                    const option = document.createElement('option');
                    option.value = diameter.toFixed(2);
                    option.textContent = `${diameter.toFixed(2)} m`;
                    pipeDiameterSelect.appendChild(option);
                });
                pipeDiameterSelect.value = PIPE_DIAMETERS[0].toFixed(2);
            }
            if (boxCommercialSelect && boxCommercialSelect.options.length === 1) {
                BOX_SECTIONS.forEach(section => {
                    const option = document.createElement('option');
                    option.value = `${section.width}x${section.height}`;
                    option.dataset.width = section.width;
                    option.dataset.height = section.height;
                    option.textContent = section.label;
                    boxCommercialSelect.appendChild(option);
                });
            }
        }

        function resetHydraulicOutputs() {
            setText('res-d-theo', 0);
            setPipeSelectedLabel('--');
            updatePipeSuggestionDisplay();
            setText('res-pipe-capacity', 0);
            const pipeNeed = document.getElementById('pipe-q-needed');
            if (pipeNeed) {
                pipeNeed.textContent = '--';
            }
            setText('res-box-h', 0);
            setText('res-box-capacity', 0);
            const boxNeed = document.getElementById('box-q-needed');
            if (boxNeed) {
                boxNeed.textContent = '--';
            }
            const boxSuggestion = document.getElementById('box-suggestion');
            if (boxSuggestion) {
                boxSuggestion.textContent = 'Sob medida';
            }
            setText('res-channel-y', 0);
            const svgText = document.getElementById('svg-d');
            if (svgText) {
                svgText.textContent = '--';
            }
            const zInput = document.getElementById('channel-z');
            const zValue = zInput ? parseFloat(zInput.value) : 1.5;
            updateChannelSvg(0, zValue || 1.5);
        }

        function setText(id, value, decimals = 1) {
            const el = document.getElementById(id);
            if (!el) {
                return;
            }
            if (value > 0) {
                const digits = typeof decimals === 'number' ? decimals : 1;
                el.textContent = value.toFixed(digits);
            } else {
                el.textContent = '--';
            }
        }

        const citySelect = document.getElementById('city-select');
        const selectTabBtn = document.getElementById('select-tab');
        const rainModal = document.getElementById('rainModal');
        function toNumberString(val) {
            const s = (val ?? '').toString().trim();
            // normaliza vírgula decimal para ponto
            return s.replace(/,/g, '.');
        }
        function applySelectedCity() {
            if (!citySelect) return;
            const normalize = (s) => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            let option = citySelect.selectedOptions && citySelect.selectedOptions[0]
                ? citySelect.selectedOptions[0]
                : citySelect.options[citySelect.selectedIndex || 0];
            if (!option) {
                for (let i = 0; i < citySelect.options.length; i++) {
                    const opt = citySelect.options[i];
                    if (normalize(opt.textContent) === normalize('Nova Petrópolis - RS')) {
                        citySelect.selectedIndex = i;
                        option = opt;
                        break;
                    }
                }
            }
            if (!option) return;
            const kEl = document.getElementById('rain-k');
            const aEl = document.getElementById('rain-a');
            const bEl = document.getElementById('rain-b');
            const cEl = document.getElementById('rain-c');
            if (!kEl || !aEl || !bEl || !cEl) return;
            const k = option.dataset.k ?? option.getAttribute('data-k');
            const a = option.dataset.a ?? option.getAttribute('data-a');
            const b = option.dataset.b ?? option.getAttribute('data-b');
            const c = option.dataset.c ?? option.getAttribute('data-c');
            kEl.value = toNumberString(k);
            aEl.value = toNumberString(a);
            bEl.value = toNumberString(b);
            cEl.value = toNumberString(c);
            calculateAll();
        }
        applySelectedCity();
        if (citySelect) {
            citySelect.addEventListener('change', applySelectedCity);
        }
        if (rainModal) {
            rainModal.addEventListener('shown.bs.modal', applySelectedCity);
        }
        if (selectTabBtn) {
            selectTabBtn.addEventListener('shown.bs.tab', applySelectedCity);
        }

        

        const newEqForm = document.getElementById('new-eq-form');
        if (newEqForm) {
            newEqForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const name = document.getElementById('new-name').value;
                const k = document.getElementById('new-k').value;
                const a = document.getElementById('new-a').value;
                const b = document.getElementById('new-b').value;
                const c = document.getElementById('new-c').value;

                fetch('{% url "ferramenta_drenagem:add_equation" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ name, k, a, b, c })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const option = document.createElement('option');
                            option.value = data.id;
                            option.text = data.name;
                            option.dataset.k = k;
                            option.dataset.a = a;
                            option.dataset.b = b;
                            option.dataset.c = c;
                            citySelect.add(option);
                            citySelect.value = data.id;

                            document.getElementById('rain-k').value = k;
                            document.getElementById('rain-a').value = a;
                            document.getElementById('rain-b').value = b;
                            document.getElementById('rain-c').value = c;

                            const bsTab = new bootstrap.Tab(document.getElementById('select-tab'));
                            bsTab.show();

                            newEqForm.reset();
                            calculateAll();
                            alert('Equação adicionada com sucesso!');
                        } else {
                            alert('Erro ao adicionar: ' + data.message);
                        }
                    })
                    .catch(() => alert('Erro de conexão.'));
            });
        }
    });
</script>
{% endblock %}